# Render Blueprint for CollectIQ Platform
# This file defines all services needed to deploy the full application on Render

databases:
  - name: collectiq-db
    databaseName: collectiq
    user: collectiq
    plan: free
    region: oregon
    ipAllowList: []

services:
  # Redis Cache Service
  - type: redis
    name: collectiq-redis
    plan: free
    region: oregon
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []

  # ML API Service (Python Flask)
  - type: web
    name: collectiq-ml-api
    runtime: python
    region: oregon
    plan: free
    branch: master
    rootDir: ml-models
    buildCommand: pip install -r requirements.txt && python training/train_model.py || true
    startCommand: gunicorn --bind 0.0.0.0:$PORT --workers 2 --threads 4 --timeout 120 api:app
    healthCheckPath: /health
    envVars:
      - key: FLASK_ENV
        value: production
      - key: MODEL_PATH
        value: /opt/render/project/src/models
      - key: LOG_LEVEL
        value: INFO
      - key: PYTHON_VERSION
        value: 3.10.0

  # Backend API Service (Node.js Express)
  - type: web
    name: collectiq-backend
    runtime: node
    region: oregon
    plan: free
    branch: master
    rootDir: backend
    buildCommand: npm ci && npm run build
    startCommand: node dist/server.js
    healthCheckPath: /api/health
    envVars:
      - key: NODE_ENV
        value: production
      - key: NODE_VERSION
        value: 18.0.0
      - key: DATABASE_URL
        fromDatabase:
          name: collectiq-db
          property: connectionString
      - key: DB_DIALECT
        value: postgres
      - key: DB_SSL
        value: true
      - key: REDIS_URL
        fromService:
          type: redis
          name: collectiq-redis
          property: connectionString
      - key: ML_API_URL
        fromService:
          type: web
          name: collectiq-ml-api
          property: host
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_EXPIRES_IN
        value: 7d
      - key: CORS_ORIGIN
        fromService:
          type: web
          name: collectiq-frontend
          property: host
      - key: MAX_FILE_SIZE
        value: 10485760
      - key: DEFAULT_SLA_HOURS
        value: 48
      - key: ESCALATION_SLA_HOURS
        value: 72
      - key: DEFAULT_PAGE_SIZE
        value: 20
      - key: MAX_PAGE_SIZE
        value: 100
      # Optional external service credentials (set in Render dashboard)
      - key: SENDGRID_API_KEY
        sync: false
      - key: TWILIO_ACCOUNT_SID
        sync: false
      - key: TWILIO_AUTH_TOKEN
        sync: false
      - key: TWILIO_PHONE_NUMBER
        sync: false

  # Frontend Static Site (React + Vite)
  - type: web
    name: collectiq-frontend
    runtime: static
    plan: free
    branch: master
    rootDir: frontend
    buildCommand: npm ci && npm run build
    staticPublishPath: dist
    headers:
      - path: /*
        name: X-Frame-Options
        value: DENY
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: X-XSS-Protection
        value: 1; mode=block
    routes:
      - type: rewrite
        source: /api/*
        destination: https://collectiq-backend.onrender.com/api/*
      - type: rewrite
        source: /*
        destination: /index.html
    envVars:
      - key: NODE_VERSION
        value: 18.0.0
      - key: VITE_API_URL
        fromService:
          type: web
          name: collectiq-backend
          property: host
      - key: VITE_APP_NAME
        value: CollectIQ
      - key: VITE_APP_VERSION
        value: 1.0.0
